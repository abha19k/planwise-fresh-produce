<c-card>
    <c-card-header>
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-2">
          <label class="form-label">Period</label>
          <select class="form-select" [formControl]="periodSelection">
            <option>Daily</option>
            <option>Weekly</option>
            <option>Monthly</option>
          </select>
        </div>
  
        <div class="col-12 col-md-2">
          <label class="form-label">Variant</label>
          <select class="form-select" [formControl]="variantSelection">
            <option value="feat">feat</option>
            <option value="baseline">baseline</option>
          </select>
        </div>
  
        <div class="col-12 col-md-3">
          <label class="form-label">ProductID</label>
          <select class="form-select" [formControl]="productIdCtrl">
            <option value="">(Any)</option>
            <option *ngFor="let v of productIds" [value]="v">{{ v }}</option>
          </select>
        </div>
  
        <div class="col-12 col-md-2">
          <label class="form-label">ChannelID</label>
          <select class="form-select" [formControl]="channelIdCtrl">
            <option value="">(Any)</option>
            <option *ngFor="let v of channelIds" [value]="v">{{ v }}</option>
          </select>
        </div>
  
        <div class="col-12 col-md-3">
          <label class="form-label">LocationID</label>
          <select class="form-select" [formControl]="locationIdCtrl">
            <option value="">(Any)</option>
            <option *ngFor="let v of locationIds" [value]="v">{{ v }}</option>
          </select>
        </div>
  
        <div class="col-12 d-flex gap-2 mt-2">
          <button cButton color="primary" (click)="computeSingleKpi()" [disabled]="loading">
            Compute KPI (Key)
          </button>
          <button cButton color="dark" (click)="computeQueryKpi()" [disabled]="loading">
            Compute KPI (Query)
          </button>
          <button cButton color="secondary" (click)="clear()" [disabled]="loading">
            Clear
          </button>
        </div>
      </div>
    </c-card-header>
  
    <c-card-body>
      <div *ngIf="errorMessage" class="text-danger mb-2">{{ errorMessage }}</div>
  
      <!-- ===== Query picker ===== -->
      <div class="row g-2 align-items-end mb-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Saved searches</label>
          <select class="form-select" [formControl]="savedSearchId">
            <option [ngValue]="null">— choose —</option>
            <option *ngFor="let s of savedSearches" [ngValue]="s.id">{{ s.name }}</option>
          </select>
        </div>
  
        <div class="col-12 col-md-8">
          <label class="form-label">Query</label>
          <input class="form-control" type="text" [formControl]="queryCtrl"
                 placeholder="e.g. productid:APPLE_ELSTAR AND channelid:AH AND locationid:NL-GE" />
          <div class="form-text">
            Uses your saved-search query language. We compute KPIs by aggregating matched keys (max 200).
          </div>
        </div>
      </div>
  
      <!-- ===== Single KPI cards ===== -->
      <div *ngIf="singleCards.length" class="mb-4">
        <div class="d-flex justify-content-between align-items-end mb-2">
          <div>
            <div class="fw-semibold">KPIs for selected key</div>
            <div class="text-muted small">
              {{ singleKpi?.key?.ProductID }} / {{ singleKpi?.key?.ChannelID }} / {{ singleKpi?.key?.LocationID }}
              • {{ singleKpi?.period }} • {{ singleKpi?.variant }}
              • n={{ singleKpi?.metrics?.n }}
            </div>
          </div>
        </div>
  
        <div class="row g-2">
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2" *ngFor="let c of singleCards">
            <c-card class="h-100">
              <c-card-body>
                <div class="text-muted small">{{ c.title }}</div>
                <div class="fs-4 fw-semibold">
                  {{ c.value | number:'1.2-2' }}{{ c.suffix }}
                </div>
                <div class="text-muted small">{{ c.hint }}</div>
              </c-card-body>
            </c-card>
          </div>
        </div>
  
        <!-- optional detail table -->
        <div class="mt-3">
          <table cTable class="table-sm">
            <thead>
              <tr>
                <th>SAE</th><th>SAA</th><th>Pairs (n)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ singleKpi?.metrics?.sae | number:'1.2-2' }}</td>
                <td>{{ singleKpi?.metrics?.saa | number:'1.2-2' }}</td>
                <td>{{ singleKpi?.metrics?.n }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
  
      <!-- ===== Query KPI cards ===== -->
      <div *ngIf="queryCards.length">
        <div class="d-flex justify-content-between align-items-end mb-2">
          <div>
            <div class="fw-semibold">Aggregate KPIs for query</div>
            <div class="text-muted small">
              {{ queryKpi?.period }} • {{ queryKpi?.variant }} • keys={{ queryKpi?.keys }}
            </div>
            <div class="text-muted small">
              <code>{{ queryKpi?.query }}</code>
            </div>
          </div>
        </div>
  
        <div class="row g-2">
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2" *ngFor="let c of queryCards">
            <c-card class="h-100">
              <c-card-body>
                <div class="text-muted small">{{ c.title }}</div>
                <div class="fs-4 fw-semibold">
                  {{ c.value | number:'1.2-2' }}{{ c.suffix }}
                </div>
                <div class="text-muted small">{{ c.hint }}</div>
              </c-card-body>
            </c-card>
          </div>
        </div>
  
        <!-- optional detail table -->
        <div class="mt-3">
          <table cTable class="table-sm">
            <thead>
              <tr><th>WAPE%</th><th>SAE</th><th>SAA</th><th>Pairs (n)</th><th>Keys</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ queryKpi?.metrics?.wape | number:'1.2-2' }}</td>
                <td>{{ queryKpi?.metrics?.sae  | number:'1.2-2' }}</td>
                <td>{{ queryKpi?.metrics?.saa  | number:'1.2-2' }}</td>
                <td>{{ queryKpi?.metrics?.n }}</td>
                <td>{{ queryKpi?.keys }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </c-card-body>
  </c-card>
  