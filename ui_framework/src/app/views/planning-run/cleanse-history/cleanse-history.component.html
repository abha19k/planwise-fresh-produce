<!-- Settings -->
<c-card>
  <c-card-header>Cleanse History — Settings</c-card-header>

  <c-card-body>
    <form [formGroup]="form" class="row g-3">

      <!-- Saved Profiles -->
      <div class="col-12">
        <label class="form-label">Saved Profiles</label>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            *ngFor="let p of profiles"
            (click)="loadProfile(p)">
            {{ p.name }}
          </button>
        </div>
      </div>

      <!-- Profile Name -->
      <div class="col-sm-4">
        <label class="form-label">Profile name</label>
        <input class="form-control" placeholder="Profile name…" formControlName="profileName" />
      </div>

      <!-- Outlier Method -->
      <div class="col-sm-4">
        <label class="form-label">Outlier method</label>
        <select class="form-select" formControlName="outlierMethod">
          <option>Z-Score</option>
          <option>IQR</option>
          <option>MAD</option>
          <option>Hampel</option>
        </select>
      </div>

      <!-- Outlier Params -->
      <div class="col-12" formGroupName="outlierParams">
        <div class="row g-3">
          <div class="col-sm-3" *ngIf="outlierMethod === 'Z-Score'">
            <label class="form-label">Z threshold</label>
            <input type="number" step="0.1" class="form-control" formControlName="zThreshold" />
          </div>
          <div class="col-sm-3" *ngIf="outlierMethod === 'IQR'">
            <label class="form-label">k (IQR multiplier)</label>
            <input type="number" step="0.1" class="form-control" formControlName="iqrK" />
          </div>
          <div class="col-sm-3" *ngIf="outlierMethod === 'MAD'">
            <label class="form-label">k (MAD multiplier)</label>
            <input type="number" step="0.1" class="form-control" formControlName="madK" />
          </div>
          <div class="col-sm-3" *ngIf="outlierMethod === 'Hampel'">
            <label class="form-label">Window (periods)</label>
            <input type="number" class="form-control" formControlName="hampelWindow" />
          </div>
          <div class="col-sm-3" *ngIf="outlierMethod === 'Hampel'">
            <label class="form-label">k (MAD multiplier)</label>
            <input type="number" step="0.1" class="form-control" formControlName="hampelK" />
          </div>
        </div>
      </div>

      <!-- Missing strategy -->
      <div class="col-sm-4">
        <label class="form-label">Missing data strategy</label>
        <select class="form-select" formControlName="missingMethod">
          <option>Drop Rows</option>
          <option>Forward Fill</option>
          <option>Backward Fill</option>
          <option>Zero</option>
          <option>Mean</option>
          <option>Median</option>
          <option>Linear Interpolate</option>
        </select>
      </div>

      <!-- Missing params -->
      <div class="col-12" formGroupName="missingParams">
        <div class="row g-3">
          <div class="col-sm-3">
            <label class="form-label">Interpolation order</label>
            <input type="number" class="form-control" formControlName="interpolateOrder" />
          </div>
          <div class="col-sm-3">
            <label class="form-label">Fill constant</label>
            <input type="number" class="form-control" formControlName="fillConstant" />
          </div>
        </div>
      </div>

    </form>

    <div *ngIf="errorMessage" class="alert alert-danger mt-3 mb-0">{{ errorMessage }}</div>
  </c-card-body>

  <c-card-footer class="d-flex gap-2 flex-wrap">
    <button class="btn btn-primary" (click)="saveProfile()" [disabled]="loading">
      Save profile
    </button>
  </c-card-footer>
</c-card>

<!-- Saved search + period + load/generate/save -->
<c-card class="mt-3">
  <c-card-header>Run on Saved Search</c-card-header>
  <c-card-body>
    <div class="row g-3 align-items-end">
      <div class="col-sm-6">
        <label class="form-label">Saved Search</label>
        <select class="form-select" [formControl]="selectedSavedIndex">
          <option [ngValue]="-1">-- Choose a saved search --</option>
          <option *ngFor="let s of savedSearches; let i = index" [ngValue]="i">
            {{ s.name }} — {{ s.query }}
          </option>
        </select>
      </div>

      <div class="col-sm-3">
        <label class="form-label">Period</label>
        <select class="form-select" [formControl]="periodSelection">
          <option value="Daily">Daily</option>
          <option value="Weekly">Weekly</option>
          <option value="Monthly">Monthly</option>
        </select>
      </div>

      <div class="col-sm-3 text-sm-end">
        <button class="btn btn-outline-primary w-100"
                (click)="loadHistoryFromSaved()"
                [disabled]="loading || (selectedSavedIndex.value ?? -1) === -1">
          Load history
        </button>
      </div>
    </div>

    <hr class="my-3" />

    <div class="row g-3 align-items-end">
      <div class="col-sm-6">
        <div class="text-muted">
          Loaded rows: <strong>{{ rawHistory?.length || 0 }}</strong>
        </div>
        <div class="text-muted">
          Preview rows ready to save: <strong>{{ previewRows?.length || 0 }}</strong>
          <span class="ms-2 small">(saved with Type = <code>Cleansed-History</code>)</span>
        </div>
      </div>

      <div class="col-sm-3">
        <button class="btn btn-secondary w-100"
                (click)="generatePreview()"
                [disabled]="loading || !rawHistory?.length">
          Generate preview
        </button>
      </div>

      <div class="col-sm-3">
        <button class="btn btn-success w-100"
                (click)="saveCleansedHistory()"
                [disabled]="saving || !(previewRows?.length)">
          {{ saving ? 'Saving…' : 'Run Process: Cleanse History' }}
        </button>
      </div>
    </div>

    <div *ngIf="saveMessage" class="alert alert-success mt-3">{{ saveMessage }}</div>
    <div *ngIf="saveError" class="alert alert-danger mt-3">{{ saveError }}</div>
  </c-card-body>
</c-card>
